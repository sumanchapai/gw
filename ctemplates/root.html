<html>
  <head>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0 auto;
        padding: 2rem;
        max-width: 1200px;
        background: #f9fafb;
        color: #111;
      }
      header {
        margin-bottom: 2rem;
      }
      h1 {
        margin: 0;
        font-size: 1.75rem;
      }
      nav {
        margin-bottom: 1.5rem;
      }
      nav a {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
      }
      nav a:hover {
        text-decoration: underline;
      }
      section {
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      section h2 {
        margin-top: 0;
        font-size: 1.25rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      .form-holder {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .form-holder > div {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      label {
        font-weight: 500;
      }
      input[type="text"] {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        flex: 1;
        background: #fff;
        color: #111;
      }
      input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }
      button {
        display: inline-block;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      button:hover {
        background: #1d4ed8;
      }
      pre {
        background: #f3f4f6;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.75rem;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      /* Layout */
      .main-container {
        display: flex;
        flex-direction: column-reverse;
        gap: 1.5rem;
      }
      .controls-panel {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      @media (min-width: 900px) {
        .main-container {
          flex-direction: row;
          align-items: flex-start;
        }
        .controls-panel {
          flex: 1;
          min-width: 300px;
          max-width: 400px;
          display: flex;
          flex-direction: column;
          gap: 2rem;
        }
        .diff-panel {
          flex: 2;
          min-width: 400px;
        }
      }

      /* --- Dark Mode --- */
      @media (prefers-color-scheme: dark) {
        body {
          background: #111827; /* dark gray */
          color: #f3f4f6; /* light text */
        }
        section {
          background: #1f2937; /* darker panel */
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
        }
        section h2 {
          border-bottom: 1px solid #374151;
        }
        nav a {
          color: #60a5fa;
        }
        input[type="text"] {
          background: #111827;
          border: 1px solid #374151;
          color: #f3f4f6;
        }
        pre {
          background: #111827;
          border: 1px solid #374151;
          color: #e5e7eb;
        }
        button {
          background: #3b82f6;
        }
        button:hover {
          background: #2563eb;
        }
      }

      /* Git diff syntax highlighting */
      .diff-line {
        display: block;
        white-space: pre-wrap;
        font-family: monospace;
      }
      .diff-add {
        background: #e6ffed;
        color: #22863a;
      }
      .diff-remove {
        background: #ffeef0;
        color: #b31d28;
      }
      .diff-hunk {
        background: #f1f8ff;
        color: #0366d6;
        font-weight: bold;
      }
      .diff-meta {
        color: #6a737d;
      }
      @media (prefers-color-scheme: dark) {
        .diff-add {
          background: #144620;
          color: #85e89d;
        }
        .diff-remove {
          background: #86181d;
          color: #fdaeb7;
        }
        .diff-hunk {
          background: #1b1f23;
          color: #79b8ff;
        }
        .diff-meta {
          color: #9ca3af;
        }
      }

      .commit-btn-col {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: start;
        margin-top: 0.75rem;
      }

      .commit-btn-col button {
        width: 100%;
      }

      .commit-small {
        display: block;
        font-size: 0.8rem;
        color: white; /* neutral */
        margin-top: 0.25rem;
      }
      @media (prefers-color-scheme: dark) {
        .commit-small {
          color: #9ca3af;
        }
      }
      .busy {
        opacity: 0.7;
        pointer-events: none;
      }

      .step-output {
        height: 100px;
        overflow-y: auto;
        margin-top: 0.75rem;
        font-family: monospace;
        white-space: pre-wrap;
        background: #0; /* kept by existing pre rules */
      }

      .outer-wrapper {
        position: relative; /* important for absolute positioning */
      }

      .output-spinner {
        position: absolute;
        top: 0.5rem;
        right: 0.75rem;
        width: 16px;
        height: 16px;
        border: 2px solid #888;
        border-top: 2px solid #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none; /* hidden by default */
      }

      @keyframes spin {
        0% {
          transform: rotate(0);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Git Web</h1>
    </header>

    {{ if .BackLink }}
    <nav>
      <a href="{{ .BackLink }}">‚Üê Back</a>
    </nav>
    {{ end }}

    <div class="main-container">
      <!-- LEFT: controls -->
      <div class="controls-panel">
        <section>
          <h2>Branch</h2>
          <select id="branch-select" name="branch">
            <option value="{{.CurrentBranch}}">{{ .CurrentBranch }}</option>
            {{range .OtherBranches }}
            <option value="{{.}}">{{.}}</option>
            {{end}}
          </select>
        </section>

        <section>
          <div class="controls-header">
            <h2>Commit &amp; Push</h2>
          </div>

          <!-- Buttons -->
          <div class="commit-btn-col">
            <button id="btn-commit">
              <p>Commit</p>
              <span class="commit-small">Stages all changes</span>
            </button>

            <button id="btn-commit-push">
              <p>Commit + Push</p>
              <span class="commit-small">Requires ssh key setup to push</span>
            </button>

            <button id="btn-commit-pr">
              <p>Commit + Create PR</p>
              <span class="commit-small">Requires `gh` installed</span>
            </button>

            <small>Commits always stages all changes automatically.</small>
          </div>

          <!-- area to show step outputs -->
          <div class="outer-wrapper">
            <pre id="commit-action-output" class="step-output">
Result will appear here </pre
            >
            <div id="commit-spinner" class="output-spinner"></div>
          </div>
        </section>

        <section>
          <form class="git-command-form">
            <h2>Run Git Command</h2>
            <div class="form-holder">
              <div>
                <label for="command">Command:</label>
                <input id="command" type="text" placeholder="e.g. status" />
                <button type="submit">Run</button>
              </div>
              <pre id="command-result">Result will appear here...</pre>
            </div>
          </form>
        </section>
      </div>

      <!-- RIGHT: diff -->
      <div class="diff-panel">
        <section>
          <h2>Diff</h2>
          <pre id="diff-result">Loading git diff...</pre>
        </section>
      </div>
    </div>

    <script>
      // Run arbitrary git command
      document
        .querySelector(".git-command-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const cmd = document.getElementById("command").value.trim();
          if (!cmd) return;

          const resultBox = document.getElementById("command-result");
          resultBox.textContent = "Running...";
          try {
            const resp = await fetch("/git-command", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ args: cmd.split(" ") }),
            });
            const data = await resp.json();
            resultBox.textContent = data.output || data.error || "(no output)";
            // Refresh diff
            loadDiff();
          } catch (err) {
            resultBox.textContent = "Error: " + err.message;
            // Refresh diff
            loadDiff();
          }
        });

      // Switch branch on select change
      document
        .getElementById("branch-select")
        .addEventListener("change", async (e) => {
          const branch = e.target.value;
          e.target.disabled = true;
          try {
            const resp = await fetch("/git-command", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ args: ["checkout", branch] }),
            });
            const data = await resp.json();

            if (data.success) {
              alert(`Switched to branch: ${branch}`);
              loadDiff();
            } else {
              alert("Error switching branch:\n" + (data.error || data.output));
              e.target.value = "{{.CurrentBranch}}";
            }
          } catch (err) {
            alert("Request failed: " + err.message);
            e.target.value = "{{.CurrentBranch}}";
          } finally {
            e.target.disabled = false;
          }
        });

      // Load git diff on page load
      async function loadDiff() {
        const noDiff = "(no diff)";
        const diffBox = document.getElementById("diff-result");
        if (diffBox.textContent === noDiff) {
          diffBox.textContent = "Loading...";
        }
        try {
          const resp = await fetch("/git-command", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ args: ["diff"] }),
          });
          const data = await resp.json();
          const raw = data.output || data.error || noDiff;
          diffBox.innerHTML = highlightDiff(raw);
        } catch (err) {
          diffBox.textContent = "Error: " + err.message;
        }
      }

      function highlightDiff(diffText) {
        return diffText
          .split("\n")
          .map((line) => {
            if (line.startsWith("+") && !line.startsWith("+++")) {
              return `<span class="diff-line diff-add">${escapeHtml(line)}</span>`;
            } else if (line.startsWith("-") && !line.startsWith("---")) {
              return `<span class="diff-line diff-remove">${escapeHtml(line)}</span>`;
            } else if (line.startsWith("@@")) {
              return `<span class="diff-line diff-hunk">${escapeHtml(line)}</span>`;
            } else if (
              line.startsWith("diff ") ||
              line.startsWith("index ") ||
              line.startsWith("---") ||
              line.startsWith("+++")
            ) {
              return `<span class="diff-line diff-meta">${escapeHtml(line)}</span>`;
            } else {
              return `<span class="diff-line">${escapeHtml(line)}</span>`;
            }
          })
          .join("");
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      const btnCommit = document.getElementById("btn-commit");
      const btnCommitPush = document.getElementById("btn-commit-push");
      const btnCommitPR = document.getElementById("btn-commit-pr");
      const outputBox = document.getElementById("commit-action-output");
      const branchSelect = document.getElementById("branch-select");

      // helper: run an action on server
      async function runGitAction(payload) {
        const spinner = document.getElementById("commit-spinner");
        spinner.style.display = "block"; // show spinner
        outputBox.textContent = ""; // clear old logs

        return new Promise((resolve, reject) => {
          const ws = new WebSocket(`ws://${window.location.host}/git-action`);

          ws.onopen = () => {
            ws.send(JSON.stringify(payload));
          };

          ws.onmessage = (event) => {
            outputBox.textContent += event.data + "\n";
            outputBox.scrollTop = outputBox.scrollHeight;
          };

          ws.onerror = (err) => {
            outputBox.textContent += "\nError: " + err.message;
            spinner.style.display = "none"; // hide spinner on error
            reject(err);
          };

          ws.onclose = () => {
            spinner.style.display = "none"; // hide spinner when finished
            resolve({ success: true });
            try {
              loadDiff();
            } catch (e) {}
          };
        });
      }

      function setBusy(flag) {
        [btnCommit, btnCommitPush, btnCommitPR].forEach((b) => {
          if (flag) b.classList.add("busy");
          else b.classList.remove("busy");
          b.disabled = flag;
        });
      }

      // Button handlers:
      btnCommit.addEventListener("click", async () => {
        const commitMsg = prompt("Commit message:");
        if (!commitMsg) {
          alert("Aborted: commit message required.");
          return;
        }
        const branch = branchSelect?.value || null;
        await runGitAction({
          action: "commit",
          args: [commitMsg],
        });
      });

      btnCommitPush.addEventListener("click", async () => {
        const commitMsg = prompt("Commit message:");
        if (!commitMsg) {
          alert("Aborted: commit message required.");
          return;
        }
        const branch = branchSelect?.value || null;
        await runGitAction({
          action: "commit-push",
          branch,
          message: commitMsg,
        });
      });

      btnCommitPR.addEventListener("click", async () => {
        const commitMsg = prompt("Commit message:");
        if (!commitMsg) {
          alert("Aborted: commit message required.");
          return;
        }

        // Prompt for PR title/body (default to commit message)
        const prTitle = prompt("PR title:", commitMsg) || commitMsg;
        const prBody = prompt("PR body (optional):", "") || "";

        // Optionally choose base (default 'main')
        const prBase =
          prompt("PR base branch (default: main):", "main") || "main";

        const branch = branchSelect?.value || null;
        await runGitAction({
          action: "commit-pr",
          branch,
          message: commitMsg,
          pr_base: prBase,
          pr_title: prTitle,
          pr_body: prBody,
        });
      });

      loadDiff();
    </script>
  </body>
</html>
